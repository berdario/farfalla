<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<head>

	<script type="text/javascript" src="jquery-1.4.2.min.js"></script>
	<script type="text/javascript" src="json2.js"></script>
	<script type="text/javascript" src="jquery.cookie.js"></script>
	<script type="text/javascript" src="jquery.jsoncookie.js"></script>
	<script type="text/javascript" src="postmessage.js"></script>
	<script type="text/javascript">


	$(function(){

	var farfalla_path = 'http://localhost/farfalla/';

		if($.cookie('farfalla_plugins_cookie')){
			window.location = 'toolbar.html?update='+Math.random();
		} else {
		$.getJSON(
			farfalla_path+"profiles/index.php/profiles/menu/?callback=?",
			{},
			function(data) {
				$.each(data, function(value, name){
					$('<option>').attr('value', value).text(name).appendTo('#farfalla_profile');
				});
			}
			);
		};
	
	
		// Recall user's configuration from central db

	$("#farfalla_activator").click(function() {
	
			var farfalla_profile = $('#farfalla_profile').val();
	
	
			$.getJSON(
				farfalla_path+"profiles/index.php/profiles/retrieve/"+farfalla_profile+"/?callback=?", {},

// Recall the plugins

				function(data) {

					$.cookie('farfalla_plugins_cookie', JSON.stringify(data), { path: '/', expires: 10 });

					$('#farfalla_toolbar_form').fadeOut(1000);
					pm({
						target: window.parent,
						type: "force-reload"
					});
				}
			);



			// stop the call to the form "action"
			return false;					

	});


	
	});

	</script> 
	
	<style type="text/css" rel="stylesheet">
		body{
			background:#333;
		}
	</style>
</head>
	<body>
		<form id="farfalla_toolbar_form" action="#">
		<select id="farfalla_profile" name="farfalla_profile">
			<option>Choose your profile...</option>
			<!-- Don't look for profiles here, they are loaded dynamically! -->
		</select>
		<input type="submit" id="farfalla_activator" value="get preferences" />
		</form>
	</body>
</html>